#!/usr/bin/env node

/**
 * hashmonitor launcher
 *     invokes the main application that will continue to listen
 * @return {none}
 */
(function() {
  var DEFAULT_MILLISECONDS_FOR_SINGLE_STATS_WINDOW = 30 * 1000;
  var HashMonitor = require('../lib/hashmonitor').HashMonitor;
  var HttpAccessLogParser = require('../lib/inputs/httpaccess').HttpAccessLogParser;
  var indent = null;
  var monitor = new HashMonitor();
  var preParsers = [];
  var __indexOf = [].indexOf || function(item) {
  	for (var i = 0, l = this.length; i < l; i+=1) {
  		if (i in this && this[i] === item) {
  			return i;
  		}
  	}
  	return -1;
  };

  if (__indexOf.call(process.argv, '--parse-http-access') >= 0) {
    preParsers.push(new HttpAccessLogParser());
  }

  if (__indexOf.call(process.argv, '--pretty') >= 0) {
    indent = 4;
  }

  process.stdin.resume();
  process.stdin.setEncoding('utf8');
  process.stdin.on('data', function(line) {
    for (var _i = 0, _len = preParsers.length; _i < _len; _i+=1) {
      line = preParsers[_i].parse(line);
    }
    return monitor.parse(line);
  });

  return setInterval(function() {
    console.log(JSON.stringify(monitor.calculate(), null, indent));
    return monitor.reset();
  }, DEFAULT_MILLISECONDS_FOR_SINGLE_STATS_WINDOW);

}).call(this);
